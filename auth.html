<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Authenticate</title>
</head>

<body>
  <form name="register" method="POST">
    <input name="public_key_credential" type="hidden">
    <input type="submit" value="Register">
  </form>
  <script>
    function base64urlToBuffer(baseurl64String) {
      // Base64url to Base64
      const padding = "==".slice(0, (4 - (baseurl64String.length % 4)) % 4);
      const base64String =
        baseurl64String.replace(/-/g, "+").replace(/_/g, "/") + padding;

      // Base64 to binary string
      const str = atob(base64String);

      // Binary string to buffer
      const buffer = new ArrayBuffer(str.length);
      const byteView = new Uint8Array(buffer);
      for (let i = 0; i < str.length; i++) {
        byteView[i] = str.charCodeAt(i);
      }
      return buffer;
    }

    function bufferToBase64url(buffer) {
      // Buffer to binary string
      const byteView = new Uint8Array(buffer);
      let str = "";
      for (const charCode of byteView) {
        str += String.fromCharCode(charCode);
      }

      // Binary string to base64
      const base64String = btoa(str);

      // Base64 to base64url
      // We assume that the base64url string is well-formed.
      const base64urlString = base64String
        .replace(/\+/g, "-")
        .replace(/\//g, "_")
        .replace(/=/g, "");
      return base64urlString;
    }
    document.forms.namedItem("register").onsubmit = async (e) => {
      e.preventDefault();
      let target = e.target;
      let challenge = "{{ .Response.Challenge }}";
      let credential = await navigator.credentials.create({
        publicKey: {
          challenge: base64urlToBuffer(challenge),
          rp: {
            name: "{{ .Response.RelyingParty.Name }}",
            id: "{{ .Response.RelyingParty.ID }}"
          },
          attestation: "{{ .Response.Attestation }}",

          // There user id doesn't matter for our usecase however we could put some identifying information about the OIDC audience in here
          user: {
            id: base64urlToBuffer("zczEAX64EcKL703DK8jkTaoX87gaKxQUwSOCdFIHbc4"), // TODO more entropy
            name: "Arian",
            displayName: "Arian"
          },
          pubKeyCredParams: [{
            alg: -7,
            type: "public-key"
          }]
        }
      })

      let publicKeyCredential = JSON.stringify({
        id: credential.id,
        rawId: bufferToBase64url(credential.rawId),
        type: credential.type,
        response: {
          attestationObject: bufferToBase64url(credential.response.attestationObject),
          clientDataJSON: bufferToBase64url(credential.response.clientDataJSON),
        },
      });
      target.elements["public_key_credential"].value = publicKeyCredential
      target.submit()
    };
  </script>
</body>

</html>