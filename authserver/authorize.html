<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width , initial-scale=1.0">
  <title>Log in</title>
  <!-- CSS only -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">

</head>

<body>
  <div class="container">
    <div id="alert-placeholder">

    </div>

    <form name="loginform" id="loginform" method="POST">
      <fieldset id="register-fieldset">
        <legend>Credential</legend>
        <div class="form-group">
          <label for="">Attestation mode</label>
          <select class="form-control" name="" id="">
            <option selected>None</option>
            <option>Indirect</option>
            <option>Direct</option>
          </select>
        </div>
        <div class="form-group">
          <div class="form-check">
            <label class="form-check-label">
              <input type="checkbox" class="form-check-input" name="" id="" value="checkedValue" checked>
              Require pin or biometric for login
            </label>
          </div>
        </div>
        <button id="register" type="button" class="btn btn-primary">Register credential</button>
      </fieldset>
      <fieldset>
        <legend>Log in</legend>
        <button id="login" type="submit" class="btn btn-primary">Log in</button>
        <button id="forget" type="button" class="btn btn-secondary">Forget credential</button>
      </fieldset>
      <input type="hidden" name="assertion_response">
      <input type="hidden" name="attestation_response">
    </form>
  </div>
  <script>
    function base64urlToBuffer(baseurl64String) {
      // Base64url to Base64
      const padding = "==".slice(0, (4 - (baseurl64String.length % 4)) % 4);
      const base64String =
        baseurl64String.replace(/-/g, "+").replace(/_/g, "/") + padding;

      // Base64 to binary string
      const str = atob(base64String);

      // Binary string to buffer
      const buffer = new ArrayBuffer(str.length);
      const byteView = new Uint8Array(buffer);
      for (let i = 0; i < str.length; i++) {
        byteView[i] = str.charCodeAt(i);
      }
      return buffer;
    }

    function bufferToBase64url(buffer) {
      // Buffer to binary string
      const byteView = new Uint8Array(buffer);
      let str = "";
      for (const charCode of byteView) {
        str += String.fromCharCode(charCode);
      }

      // Binary string to base64
      const base64String = btoa(str);

      // Base64 to base64url
      // We assume that the base64url string is well-formed.
      const base64urlString = base64String
        .replace(/\+/g, "-")
        .replace(/\//g, "_")
        .replace(/=/g, "");
      return base64urlString;
    }
    var alertPlaceholder = document.getElementById('alert-placeholder');

    function alert(message, type) {
      var wrapper = document.createElement('div');
      wrapper.innerHTML = '<div class="alert alert-' + type + ' alert-dismissible" role="alert">' + message + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>';

      alertPlaceholder.append(wrapper);
    }

    function loadAttestationResponse(loginForm) {
      const attestationResponse = localStorage.getItem(clientID + "/attestation_response");
      loginForm.elements.namedItem("attestation_response").value = attestationResponse;
      document.getElementById("register-fieldset").disabled = attestationResponse != null;
      document.getElementById("login").disabled = attestationResponse == null;
      document.getElementById("forget").disabled = attestationResponse == null;
    }

    function setAttestationResponse(loginForm, attestationResponse) {
      localStorage.setItem(clientID + "/attestation_response", attestationResponse);
      loadAttestationResponse(loginForm);
    }

    function forgetAttestationResponse(loginForm) {
      localStorage.removeItem(clientID + "/attestation_response")
      loadAttestationResponse(loginForm);
    }

    const challenge = "{{ .Challenge }}";
    const clientID = "{{ .ClientID }}";

    const loginForm = document.forms.namedItem("loginform");
    loadAttestationResponse(loginForm);

    document.getElementById("forget").onclick = async (e) => {
      forgetAttestationResponse(loginForm);
    };
    document.getElementById("register").onclick = async (e) => {
      e.preventDefault();
      try {
        let credential = await navigator.credentials.create({
          publicKey: {
            challenge: base64urlToBuffer(challenge),
            rp: {
              name: "Webauthn OIDC",
            },
            // There user id doesn't matter for our usecase however we could put some identifying information about the OIDC audience in here
            user: {
              id: base64urlToBuffer("zczEAX64EcKL703DK8jkTaoX87gaKxQUwSOCdFIHbc4"), // TODO more entropy
              name: "Arian",
              displayName: "Arian"
            },
            pubKeyCredParams: [{
              alg: -7,
              type: "public-key"
            }]
          }
        });
        let attestationResponse = JSON.stringify({
          id: credential.id,
          rawId: bufferToBase64url(credential.rawId),
          type: credential.type,
          response: {
            attestationObject: bufferToBase64url(credential.response.attestationObject),
            clientDataJSON: bufferToBase64url(credential.response.clientDataJSON),
          },
        }, null, 2);

        setAttestationResponse(loginForm, attestationResponse);
      } catch (e) {
        alert(e, "danger")
      }
    };

    loginForm.onsubmit = async (e) => {
      e.preventDefault();
      let params = {
        publicKey: {
          challenge: base64urlToBuffer(challenge),
          allowCredentials: [{
            type: "public-key",
            id: base64urlToBuffer(JSON.parse(loginForm.elements["attestation_response"].value).id)
          }]
        }
      };
      console.log(params);
      let credential = await navigator.credentials.get(params);
      let assertionResponse = JSON.stringify({
        id: credential.id,
        rawId: bufferToBase64url(credential.rawId),
        type: credential.type,
        response: {
          signature: bufferToBase64url(credential.response.signature),
          clientDataJSON: bufferToBase64url(credential.response.clientDataJSON),
          authenticatorData: bufferToBase64url(credential.response.authenticatorData),
        },
      });
      console.log(assertionResponse);
      e.target.elements["assertion_response"].value = assertionResponse;
      e.target.submit();
    };
    /*loginForm.onsubmit = async (e) => {
      e.preventDefault();

    /*const credential = await navigator.credentials.create({
      publicKey: {
        challenge: base64urlToBuffer(challenge),
        rp: {
          name: "Webauthn OIDC on behalf of " + clientID
        },
        user: {
          id: base64urlToBuffer("zczEAX64EcKL703DK8jkTaoX87gaKxQUwSOCdFIHbc4"), // TODO more entropy
          name: "webauthn-oidc",
          displayName: "Webauthn OIDC on behalf of " + clientID
        },
        pubKeyCredParams: [{
          alg: -7,
          type: "public-key"
        }]
      }
    });
  };*/

    /*document.forms.namedItem("register").onsubmit = async (e) => {
      e.preventDefault();
      let target = e.target;
      let challenge = "{{ .Challenge }}";
      let credential = await navigator.credentials.create({
        publicKey: {
          challenge: base64urlToBuffer(challenge),
          rp: {
            name: "Webauthn OIDC",
          },
          // There user id doesn't matter for our usecase however we could put some identifying information about the OIDC audience in here
          user: {
            id: base64urlToBuffer("zczEAX64EcKL703DK8jkTaoX87gaKxQUwSOCdFIHbc4"), // TODO more entropy
            name: "Arian",
            displayName: "Arian"
          },
          pubKeyCredParams: [{
            alg: -7,
            type: "public-key"
          }]
        }
      });
      // make sure follow-up logins are easy

      let attestationResponse = JSON.stringify({
        id: credential.id,
        rawId: bufferToBase64url(credential.rawId),
        type: credential.type,
        response: {
          attestationObject: bufferToBase64url(credential.response.attestationObject),
          clientDataJSON: bufferToBase64url(credential.response.clientDataJSON),
        },
      }, null, 2);
      target.elements["attestation_response"].value = attestationResponse
      localStorage.setItem("attestation_response", attestationResponse);

      console.log(credential.id.length)
      loginForm.elements["attestation_response"].value = localStorage.getItem("attestation_response")
      //target.submit()
    };


    loginForm.onsubmit = async (e) => {
      e.preventDefault();
      let target = e.target;
      let challenge = "{{ .Challenge }}";
      let attestationResponse = loginForm.elements["attestation_response"].value;
      let credential = await navigator.credentials.get({
        publicKey: {
          challenge: base64urlToBuffer(challenge),
          allowCredentials: [{
            type: "public-key",
            id: base64urlToBuffer(JSON.parse(attestationResponse).id)
          }]
        }
      });
      let assertionResponse = JSON.stringify({
        id: credential.id,
        rawId: bufferToBase64url(credential.rawId),
        type: credential.type,
        response: {
          signature: bufferToBase64url(credential.response.signature),
          clientDataJSON: bufferToBase64url(credential.response.clientDataJSON),
          authenticatorData: bufferToBase64url(credential.response.authenticatorData),
        },
      });
      target.elements["assertion_response"].value = assertionResponse;
      target.submit()
    };*/
  </script>
</body>

</html>